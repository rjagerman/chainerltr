from io import BytesIO
from chainerltr.dataset import load

dataset_txt = """0 qid:1 1:1.000000 2:1.000000 3:0.833333 4:0.871264 5:0 6:0 7:0 8:0.941842 9:1.000000 10:1.000000 11:1.000000 12:1.000000 13:1.000000 14:1.000000 15:1.000000 16:1.000000 17:1.000000 18:0.719697 19:0.729351 20:0 21:0 22:0 23:0.811565 24:1.000000 25:0.972730 26:1.000000 27:1.000000 28:0.922374 29:0.946654 30:0.938888 31:1.000000 32:1.000000 33:0.711276 34:0.722202 35:0 36:0 37:0 38:0.798002 39:1.000000 40:1.000000 41:1.000000 42:1.000000 43:0.959134 44:0.963919 45:0.971425 #docid = 244338
2 qid:1 1:0.600000 2:0.600000 3:1.000000 4:1.000000 5:0 6:0 7:0 8:1.000000 9:0.624834 10:0.767301 11:0.816099 12:0.934805 13:0.649685 14:0.680222 15:0.686762 16:0.421053 17:0.680904 18:1.000000 19:1.000000 20:0 21:0 22:0 23:1.000000 24:0.401391 25:0.938966 26:0.949446 27:0.984769 28:0.955266 29:1.000000 30:0.997786 31:0.441860 32:0.687033 33:1.000000 34:1.000000 35:0 36:0 37:0 38:1.000000 39:0.425450 40:0.975968 41:0.928785 42:0.978524 43:0.979553 44:1.000000 45:1.000000 #docid = 143821
0 qid:1 1:0.400000 2:0.400000 3:0.555555 4:0.563658 5:0 6:0 7:0 8:0.545844 9:0.380576 10:0.427356 11:0.468244 12:0.756579 13:0.366316 14:0.360838 15:0.373909 16:0.210526 17:0.479859 18:0.595237 19:0.608701 20:0 21:0 22:0 23:0.613865 24:0.184562 25:0.791539 26:0.863833 27:0.957024 28:0.896468 29:0.941132 30:0.946305 31:0.232558 32:0.507810 33:0.603068 34:0.616847 35:0 36:0 37:0 38:0.614004 39:0.202374 40:0.812801 41:0.868091 42:0.958879 43:0.926045 44:0.944576 45:0.963753 #docid = 285257
0 qid:1 1:0.200000 2:0.200000 3:0.277778 4:0.281830 5:0 6:0 7:0 8:0.330027 9:0.244258 10:0.303171 11:0.301165 12:0.614995 13:0.255036 14:0.188541 15:0.205136 16:0.368421 17:0.637735 18:0.795453 19:0.802720 20:0 21:0 22:0 23:0.851563 24:0.364249 25:0.897048 26:0.914052 27:0.973615 28:0.923365 29:0.954078 30:0.965119 31:0.348837 32:0.600470 33:0.711821 34:0.718938 35:0 36:0 37:0 38:0.773746 39:0.354506 40:0.871098 41:0.865835 42:0.958123 43:0.917441 44:0.918191 45:0.935256 #docid = 201684
1 qid:1 1:0.000000 2:0.000000 3:0.000000 4:0.000000 5:0 6:0 7:0 8:0.000000 9:0.000000 10:0.000000 11:0.000000 12:0.000000 13:0.000000 14:0.000000 15:0.000000 16:0.263158 17:0.592453 18:0.328947 19:0.340126 20:0 21:0 22:0 23:0.393538 24:0.258450 25:0.651875 26:0.885764 27:0.964385 28:0.976550 29:0.970655 30:0.984686 31:0.232558 32:0.546115 33:0.295381 34:0.306186 35:0 36:0 37:0 38:0.355037 39:0.230125 40:0.613531 41:0.860290 42:0.956255 43:0.973015 44:0.939784 45:0.960934 #docid = 48192
2 qid:1 1:0.600000 2:0.600000 3:0.625000 4:0.646018 5:0 6:0 7:0 8:0.688486 9:0.607305 10:0.643878 11:0.670966 12:0.871984 13:0.598684 14:0.595940 15:0.604204 16:0.210526 17:0.479859 18:0.446428 19:0.458833 20:0 21:0 22:0 23:0.482018 24:0.191077 25:0.628155 26:0.793447 27:0.932070 28:0.822335 29:0.828047 30:0.838679 31:0.255814 32:0.546115 33:0.497532 34:0.511428 35:0 36:0 37:0 38:0.535936 39:0.234274 40:0.696441 41:0.844624 42:0.950913 43:0.873818 44:0.862361 45:0.900401 #docid = 111457
2 qid:16 1:0.750000 2:0.750000 3:0.500000 4:0.535837 5:0 6:0 7:0 8:0.617886 9:0.678440 10:0.829193 11:0.820538 12:0.933762 13:0.835391 14:0.779902 15:0.779902 16:0.741935 17:0.907462 18:1.000000 19:1.000000 20:0 21:0 22:0 23:1.000000 24:0.629936 25:1.000000 26:0.978155 27:0.992875 28:0.809396 29:0.859716 30:0.843703 31:0.787879 32:0.899428 33:0.236364 34:0.263176 35:0 36:0 37:0 38:0.308543 39:0.663472 40:0.522875 41:0.928220 42:0.976300 43:0.819351 44:0.665771 45:0.721354 #docid = 77551
0 qid:16 1:0.750000 2:0.750000 3:0.600000 4:0.633761 5:0 6:0 7:0 8:0.706452 9:0.678440 10:0.873445 11:0.870330 12:0.953490 13:0.844582 14:0.813557 15:0.813557 16:0.161290 17:0.450835 18:0.502415 19:0.513837 20:0 21:0 22:0 23:0.472731 24:0.118967 25:0.607601 26:0.782479 27:0.920868 28:0.761328 29:0.810871 30:0.776528 31:0.242424 32:0.586275 33:0.160000 34:0.181778 35:0 36:0 37:0 38:0.207651 39:0.191958 40:0.410028 41:0.896155 42:0.965114 43:0.855650 44:0.700766 45:0.788961 #docid = 336131
2 qid:16 1:0.750000 2:0.750000 3:0.333333 4:0.366240 5:0 6:0 7:0 8:0.450797 9:0.678440 10:0.733080 11:0.700338 12:0.880717 13:0.808769 14:0.705316 15:0.705316 16:0.225806 17:0.565873 18:0.494565 19:0.506309 20:0 21:0 22:0 23:0.530383 24:0.192726 25:0.697755 26:0.870634 27:0.955308 28:0.788789 29:0.815581 30:0.813474 31:0.303030 32:0.647322 33:0.136986 34:0.155759 35:0 36:0 37:0 38:0.192331 39:0.260761 40:0.402634 41:0.888923 42:0.962536 43:0.830289 44:0.655093 45:0.727717 #docid = 251501
2 qid:16 1:0.750000 2:0.750000 3:0.600000 4:0.633761 5:0 6:0 7:0 8:0.706452 9:0.678440 10:0.873445 11:0.870330 12:0.953490 13:0.844582 14:0.813557 15:0.813557 16:0.225806 17:0.491646 18:0.659418 19:0.666205 20:0 21:0 22:0 23:0.754670 24:0.218996 25:0.868227 26:0.854483 27:0.949267 28:0.726861 29:0.757956 30:0.743703 31:0.303030 32:0.576007 33:0.188679 34:0.211530 35:0 36:0 37:0 38:0.273955 39:0.287129 40:0.500657 41:0.875014 42:0.957519 43:0.780551 44:0.627236 45:0.691513 #docid = 313204
0 qid:16 1:0.250000 2:0.250000 3:0.333333 4:0.333333 5:0 6:0 7:0 8:0.420475 9:0.321560 10:0.509470 11:0.470802 12:0.747727 13:0.427688 14:0.307775 15:0.307775 16:0.387097 17:0.647494 18:0.797955 19:0.798963 20:0 21:0 22:0 23:0.938939 24:0.412261 25:0.969178 26:0.928624 27:0.976111 28:0.759386 29:0.792259 30:0.801996 31:0.393939 32:0.624655 33:0.183099 34:0.203851 35:0 36:0 37:0 38:0.284949 39:0.426499 40:0.508488 41:0.871787 42:0.956343 43:0.758581 44:0.603141 45:0.674360 #docid = 313208
1 qid:16 1:0.500000 2:0.500000 3:0.400000 4:0.422507 5:0 6:0 7:0 8:0.513811 9:0.509110 10:0.684891 11:0.653973 12:0.857779 13:0.644522 14:0.556965 15:0.556965 16:0.451613 17:0.799345 18:0.475971 19:0.486276 20:0 21:0 22:0 23:0.557767 24:0.431399 25:0.739061 26:0.901088 27:0.966400 28:0.778388 29:0.776773 30:0.810657 31:0.484848 32:0.793891 33:0.115942 34:0.131855 35:0 36:0 37:0 38:0.177914 39:0.463326 40:0.395941 41:0.870686 42:0.955941 43:0.787500 44:0.601501 45:0.695046 #docid = 336133
1 qid:16 1:0.750000 2:0.750000 3:0.333333 4:0.366240 5:0 6:0 7:0 8:0.450797 9:0.678440 10:0.733080 11:0.700338 12:0.880717 13:0.808769 14:0.705316 15:0.705316 16:0.516129 17:0.767690 18:0.745851 19:0.752084 20:0 21:0 22:0 23:0.753912 24:0.429575 25:0.837245 26:0.897450 27:0.965095 28:0.758176 29:0.793104 30:0.797509 31:0.575758 32:0.785281 33:0.179245 34:0.201321 35:0 36:0 37:0 38:0.237659 39:0.477625 40:0.444060 41:0.870525 42:0.955882 43:0.771917 44:0.619518 45:0.687124 #docid = 145824
0 qid:16 1:0.500000 2:0.500000 3:0.250000 4:0.272947 5:0 6:0 7:0 8:0.363075 9:0.509110 10:0.607252 11:0.553255 12:0.801771 13:0.617429 14:0.498964 15:0.498964 16:0.258065 17:0.623392 18:0.482320 19:0.494334 20:0 21:0 22:0 23:0.492696 24:0.207796 25:0.651910 26:0.864017 27:0.952847 28:0.797777 29:0.815429 30:0.836508 31:0.303030 32:0.663036 33:0.120482 34:0.137461 35:0 36:0 37:0 38:0.166256 39:0.253132 40:0.366774 41:0.865708 42:0.954116 43:0.820995 44:0.639551 45:0.732058 #docid = 336132
2 qid:16 1:1.000000 2:1.000000 3:0.235294 4:0.264915 5:0 6:0 7:0 8:0.324758 9:0.828209 10:0.670373 11:0.613755 12:0.836524 13:0.908513 14:0.747990 15:0.747990 16:0.000000 17:0.000000 18:0.000000 19:0.000000 20:0 21:0 22:0 23:0.000000 24:0.000000 25:0.000000 26:0.000000 27:0.000000 28:0.000000 29:0.000000 30:0.000000 31:0.121212 32:0.369898 33:0.235294 34:0.264915 35:0 36:0 37:0 38:0.295786 39:0.095979 40:0.505119 41:0.863260 42:0.953216 43:0.819976 44:0.780842 45:0.795777 #docid = 178662
2 qid:63 1:0.142857 2:0.162076 3:0.075000 4:0.082826 5:0 6:0 7:0 8:0.117511 9:0.162051 10:0.201826 11:0.187453 12:0.518187 13:0.131888 14:0.100150 15:0.100150 16:0.000000 17:0.000000 18:0.000000 19:0.000000 20:0 21:0 22:0 23:0.000000 24:0.000000 25:0.000000 26:0.000000 27:0.000000 28:0.000000 29:0.000000 30:0.000000 31:0.026316 32:0.063236 33:0.133333 34:0.134867 35:0 36:0 37:0 38:0.185062 39:0.036628 40:0.256041 41:0.218264 42:0.600337 43:0.270977 44:0.088720 45:0.130623 #docid = 109188
2 qid:63 1:0.142857 2:0.162076 3:0.062500 4:0.069559 5:0 6:0 7:0 8:0.101651 9:0.162051 10:0.193517 11:0.171485 12:0.492566 13:0.119540 14:0.094148 15:0.074058 16:0.000000 17:0.000000 18:0.000000 19:0.000000 20:0 21:0 22:0 23:0.000000 24:0.000000 25:0.000000 26:0.000000 27:0.000000 28:0.000000 29:0.000000 30:0.000000 31:0.026316 32:0.063236 33:0.111111 34:0.113263 35:0 36:0 37:0 38:0.159870 39:0.036628 40:0.241940 41:0.214674 42:0.595982 43:0.263450 44:0.082976 45:0.106878 #docid = 191681
0 qid:63 1:0.050000 2:0.000000 3:0.000000 4:0.000000 5:0 6:0 7:0 8:0.000000 9:0.000000 10:0.000000 11:0.000000 12:0.000000 13:0.000000 14:0.000000 15:0.000000 16:0.108108 17:0.202925 18:0.133118 19:0.135694 20:0 21:0 22:0 23:0.122420 24:0.089676 25:0.188131 26:0.218182 27:0.599543 28:0.161125 29:0.132241 30:0.150754 31:0.105263 32:0.200453 33:0.053872 34:0.056603 35:0 36:0 37:0 38:0.054349 39:0.086185 40:0.107989 41:0.205438 42:0.584435 43:0.138906 44:0.081630 45:0.072691 #docid = 123928
0 qid:63 1:0.285714 2:0.324153 3:0.115385 4:0.128802 5:0 6:0 7:0 8:0.158860 9:0.260811 10:0.262112 11:0.264551 12:0.617330 13:0.218475 14:0.208065 15:0.208065 16:0.054054 17:0.101463 18:0.045759 19:0.046807 20:0 21:0 22:0 23:0.052486 24:0.055102 25:0.069303 26:0.118084 27:0.438054 28:0.000000 29:0.015419 30:0.000000 31:0.105263 32:0.189708 33:0.037825 34:0.039792 35:0 36:0 37:0 38:0.046696 39:0.105125 40:0.064656 41:0.204294 42:0.582969 43:0.088132 44:0.065962 45:0.031834 #docid = 105261
0 qid:63 1:0.142857 2:0.162076 3:0.187500 4:0.193916 5:0 6:0 7:0 8:0.219964 9:0.155887 10:0.232754 11:0.250211 12:0.601293 13:0.160330 14:0.122397 15:0.122397 16:0.000000 17:0.000000 18:0.000000 19:0.000000 20:0 21:0 22:0 23:0.000000 24:0.000000 25:0.000000 26:0.000000 27:0.000000 28:0.000000 29:0.000000 30:0.000000 31:0.026316 32:0.063236 33:0.333333 34:0.315756 35:0 36:0 37:0 38:0.325673 39:0.031733 40:0.281042 41:0.198997 42:0.576071 43:0.278119 44:0.098801 45:0.140219 #docid = 186807
0 qid:63 1:0.142857 2:0.162076 3:0.068182 4:0.075614 5:0 6:0 7:0 8:0.085071 9:0.119610 10:0.118424 11:0.132055 12:0.417374 13:0.043848 14:0.038707 15:0.038707 16:0.054054 17:0.128032 18:0.059766 19:0.061302 20:0 21:0 22:0 23:0.040034 24:0.031483 25:0.017187 26:0.100844 27:0.396541 28:0.034626 29:0.000000 30:0.006208 31:0.078947 32:0.189708 33:0.036697 34:0.038768 35:0 36:0 37:0 38:0.031501 39:0.053417 40:0.022600 41:0.170349 42:0.535255 43:0.111149 44:0.043010 45:0.026489 #docid = 50094
0 qid:63 1:0.142857 2:0.162076 3:0.125000 4:0.133960 5:0 6:0 7:0 8:0.137753 9:0.119610 10:0.144789 11:0.169829 12:0.489773 13:0.076053 14:0.058539 15:0.058539 16:0.054054 17:0.128032 18:0.075092 19:0.076919 20:0 21:0 22:0 23:0.056010 24:0.035293 25:0.036354 26:0.126655 27:0.456486 28:0.087814 29:0.036038 30:0.069390 31:0.078947 32:0.163463 33:0.047619 34:0.050043 35:0 36:0 37:0 38:0.042557 39:0.056934 40:0.034251 41:0.154984 42:0.510433 43:0.092318 44:0.014949 45:0.032874 #docid = 257182
0 qid:63 1:0.142857 2:0.162076 3:0.083333 4:0.091560 5:0 6:0 7:0 8:0.127506 9:0.162051 10:0.206637 11:0.196606 12:0.531907 13:0.138217 14:0.103619 15:0.103619 16:0.027027 17:0.064016 18:0.019018 19:0.019542 20:0 21:0 22:0 23:0.031368 24:0.039042 25:0.130170 26:0.100227 27:0.394927 28:0.000492 29:0.045364 30:0.033253 31:0.052632 32:0.100227 33:0.016360 34:0.017256 35:0 36:0 37:0 38:0.028239 39:0.073256 40:0.107416 41:0.146286 42:0.495268 43:0.000000 44:0.022711 45:0.004782 #docid = 339345
0 qid:63 1:0.142857 2:0.162076 3:0.250000 4:0.250000 5:0 6:0 7:0 8:0.167856 9:0.078385 10:0.103707 11:0.132891 12:0.419191 13:0.027399 14:0.027300 15:0.027300 16:0.000000 17:0.000000 18:0.000000 19:0.000000 20:0 21:0 22:0 23:0.000000 24:0.000000 25:0.000000 26:0.000000 27:0.000000 28:0.000000 29:0.000000 30:0.000000 31:0.026316 32:0.063236 33:0.444444 34:0.407079 35:0 36:0 37:0 38:0.189973 39:0.011360 40:0.068814 41:0.066431 42:0.287984 43:0.188175 44:0.000000 45:0.046177 #docid = 173315
2 qid:63 1:0.050000 2:0.000000 3:0.000000 4:0.000000 5:0 6:0 7:0 8:0.000000 9:0.000000 10:0.000000 11:0.000000 12:0.000000 13:0.000000 14:0.000000 15:0.000000 16:0.000000 17:0.000000 18:0.000000 19:0.000000 20:0 21:0 22:0 23:0.000000 24:0.000000 25:0.000000 26:0.000000 27:0.000000 28:0.000000 29:0.000000 30:0.000000 31:0.000000 32:0.000000 33:0.000000 34:0.000000 35:0 36:0 37:0 38:0.000000 39:0.000000 40:0.000000 41:0.000000 42:0.000000 43:0.000000 44:0.000000 45:0.000000 #docid = 9897
"""


def get_dataset(filter=False, normalize=False):
    """
    Loads the sample data set from the text contents into a
    `class:chainerltr.dataset.RankingDataset` object

    :return: The sample data set
    :rtype: `chainerltr.dataset.RankingDataset`
    """
    # Get in-memory handle
    with BytesIO() as handle:
        # Write dataset text contents to handle
        handle.write(dataset_txt.encode('utf-8'))
        handle.seek(0)

        # Read data set from handle
        dataset = load(handle, filter=filter, normalize=normalize)
        return dataset


def test_load():

    # Load dataset
    dataset = get_dataset()

    # Check if it loaded correctly
    assert dataset.nr_samples == 3

    x, y, nr_docs = dataset[0]
    assert x.shape == (6, 45)
    assert y.shape == (6,)
    assert nr_docs == 6

    x, y, nr_docs = dataset[1]
    assert x.shape == (9, 45)
    assert y.shape == (9,)
    assert nr_docs == 9

    x, y, nr_docs = dataset[2]
    assert x.shape == (10, 45)
    assert y.shape == (10,)
    assert nr_docs == 10


def test_load_normalized():

    # Todo: add rigorous checks to see if normalized contents is correct
    # dataset = get_dataset(normalize=True)
    assert True


def test_load_filtered():

    # Todo: add more rigorous checks to see if filtered contents is correct
    # dataset = get_dataset(filter=True)
    assert True
